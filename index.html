<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Etai's Tower Defence</title>

    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:title" content="Etai's Tower Defence">
    <meta property="og:description" content="A strategic tower defense game with multiple maps, tower upgrades, and endless waves. How far can you survive?">
    <meta property="og:image" content="https://etai-ai.github.io/etai-td/images/preview.png">
    <meta property="og:url" content="https://etai-ai.github.io/etai-td/">
    <meta property="og:type" content="website">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Etai's Tower Defence">
    <meta name="twitter:description" content="A strategic tower defense game with multiple maps, tower upgrades, and challenging waves.">
    <meta name="twitter:image" content="https://etai-ai.github.io/etai-td/images/preview.png">

    <link rel="stylesheet" href="css/style.css">
    <script src="https://game-cdn.poki.com/scripts/v2/poki-sdk.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "./js/lib/three.module.js",
            "three/addons/": "./js/lib/"
        }
    }
    </script>
</head>
<body>
    <div id="game-container">
        <!-- Top Info Bar -->
        <div id="top-bar">
            <div class="info-items" style="display:flex;gap:8px;align-items:center;">
                <span id="wave-info" class="wave-badge">Wave 0</span>
                <span id="kills-info" class="kills-badge">0</span>
                <span id="atmo-btn" class="atmo-badge">Standard</span>
            </div>
            <div class="controls">
                <button id="next-wave-btn">Next Wave</button>
                <span id="gold-info" class="gold-badge">&#x1FA99; 200</span>
                <div id="lives-info" class="lives-gauge">
                    <div class="lives-gauge-fill" id="lives-fill"></div>
                    <span class="lives-gauge-text" id="lives-text">&#9829; 20</span>
                </div>
                <span id="speed-btn" class="speed-badge">2x</span>
                <span id="autowave-btn" class="autowave-badge">Auto</span>
                <span id="pause-btn" class="pause-badge">&#9208; Pause</span>
                <span id="mute-btn" class="mute-badge">&#128264; Sound</span>
                <span id="exit-btn" class="exit-badge">&#10005; Quit</span>
            </div>
        </div>

        <!-- Canvas + Admin Sidebar Row -->
        <div id="canvas-row">
        <!-- 3-Layer Canvas Stack -->
        <div id="canvas-wrapper">
            <canvas id="terrain-canvas"></canvas>
            <canvas id="game-canvas"></canvas>
            <canvas id="fx-canvas"></canvas>
            <canvas id="three-canvas"></canvas>
            <canvas id="ui-canvas"></canvas>

            <!-- Tower Info Popup -->
            <div id="tower-info"></div>

            <!-- Achievement Toast -->
            <div id="achievement-toast"></div>

            <!-- Mobile Controls (hidden on desktop) -->
            <div id="mobile-controls" class="mobile-only">
                <div id="dpad">
                    <button class="dpad-btn dpad-up" data-dir="up">▲</button>
                    <button class="dpad-btn dpad-left" data-dir="left">◀</button>
                    <button class="dpad-btn dpad-center"></button>
                    <button class="dpad-btn dpad-right" data-dir="right">▶</button>
                    <button class="dpad-btn dpad-down" data-dir="down">▼</button>
                </div>
                <div id="ability-btns">
                    <button class="ability-btn" id="stun-btn" data-ability="stun">
                        <span class="ability-label">Q</span>
                        <span class="ability-name">Stun</span>
                    </button>
                    <button class="ability-btn" id="magnet-btn" data-ability="magnet">
                        <span class="ability-label">E</span>
                        <span class="ability-name">Magnet</span>
                    </button>
                    <button class="ability-btn" id="execute-btn" data-ability="execute">
                        <span class="ability-label">Z</span>
                        <span class="ability-name">Execute</span>
                    </button>
                </div>
            </div>

            <!-- Game Screens -->
            <div id="menu-screen" class="game-screen visible">
                <div class="screen-title">Etai's Tower Defence</div>
                <div class="screen-subtitle">Choose a world and survive as long as you can!</div>
                <!-- Multiplayer Lobby -->
                <div id="mp-lobby">
                    <div class="mp-lobby-row">
                        <button id="mp-create-btn" class="screen-btn mp-btn">Create Room</button>
                        <div class="mp-join-group">
                            <input id="mp-code-input" type="text" maxlength="4" placeholder="CODE" class="mp-code-input">
                            <button id="mp-join-btn" class="screen-btn mp-btn">Join</button>
                        </div>
                    </div>
                    <div id="mp-status" class="mp-status"></div>
                </div>
                <div id="map-select"></div>
                <div id="atmosphere-select">
                    <div class="atmosphere-label">Atmosphere</div>
                    <div id="atmosphere-options"></div>
                </div>
                <div class="key-hints">
                    Left click — Place / Select tower &nbsp;
                    Right click — Upgrade tower &nbsp;
                    <kbd>1</kbd>-<kbd>5</kbd> Select tower
                    <br>
                    <kbd>Space</kbd> Pause &nbsp;
                    <kbd>N</kbd> Next wave &nbsp;
                    <kbd>S</kbd> Sell &nbsp;
                    <kbd>T</kbd> Target mode
                </div>
                <div class="menu-buttons">
                    <button id="trophy-btn" class="screen-btn manual-btn">Trophies</button>
                    <button id="manual-btn" class="screen-btn manual-btn">How to Play</button>
                    <button id="about-btn" class="screen-btn manual-btn">About</button>
                    <button id="reset-btn" class="screen-btn manual-btn reset-btn">Restart!</button>
                </div>
            </div>

            <div id="manual-screen" class="game-screen">
                <div class="manual-container">
                    <div class="manual-header">
                        <div class="screen-title">How to Play</div>
                        <button id="manual-close-btn" class="screen-btn">Back</button>
                    </div>
                    <div class="manual-scroll">

                        <div class="manual-section">
                            <h2>Goal</h2>
                            <p>Build and upgrade towers to stop endless waves of enemies from reaching the exit. You start with 20 lives and 275 gold. If an enemy reaches the end, you lose lives. Lose them all and it's game over. How far can you survive?</p>
                        </div>

                        <div class="manual-section">
                            <h2>Worlds</h2>
                            <div class="manual-cards">
                                <div class="manual-card">
                                    <div class="manual-card-title" style="color:#27ae60">Serpentine Valley</div>
                                    <p>Long winding path with 10+ turns. Plenty of time to damage enemies. Best for learning.</p>
                                </div>
                                <div class="manual-card">
                                    <div class="manual-card-title" style="color:#d4a026">Split Creek</div>
                                    <p>Path forks into two branches. Enemies randomly pick a route, forcing you to defend both sides. Unlocks at Wave 30 record.</p>
                                </div>
                                <div class="manual-card">
                                    <div class="manual-card-title" style="color:#c0392b">The Gauntlet</div>
                                    <p>Short direct path with 3 turns. Enemies arrive fast — every tower counts. Unlocks at Wave 40 record.</p>
                                </div>
                            </div>
                            <p class="manual-tip">Each world is an endless survival run. Enemies get stronger every wave. At Wave 15, enemies spawn from two entry points. Unlock new worlds by reaching wave milestones on any map.</p>
                        </div>

                        <div class="manual-section">
                            <h2>Towers — Starter</h2>
                            <table class="manual-table">
                                <thead>
                                    <tr><th>Tower</th><th>Cost</th><th>Damage</th><th>Range</th><th>Rate</th><th>Special</th></tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><span class="manual-dot" style="background:#4a7c3f"></span> Arrow</td>
                                        <td>$50</td><td>12/18/28</td><td>3.5/4/4.5</td><td>2.5/3/4/s</td>
                                        <td>Cheap, fast, reliable DPS. Replaced by Fire Arrow at Wave 10.</td>
                                    </tr>
                                    <tr>
                                        <td><span class="manual-dot" style="background:#5b9bd5"></span> Frost</td>
                                        <td>$75</td><td>5/8/12</td><td>3/3.5/4</td><td>1.3/1.4/1.7/s</td>
                                        <td>Slows enemies 50-70%. Replaced by Deep Frost at Wave 10.</td>
                                    </tr>
                                    <tr>
                                        <td><span class="manual-dot" style="background:#9b59b6"></span> Lightning</td>
                                        <td>$125</td><td>15/22/32</td><td>3.5/4/4.5</td><td>1/1.2/1.4/s</td>
                                        <td>Chains to 3-5 enemies. 70% damage per bounce. Replaced by Super Lightning at wave 25.</td>
                                    </tr>
                                    <tr>
                                        <td><span class="manual-dot" style="background:#8b5e3c"></span> Cannon</td>
                                        <td>$100</td><td>30/50/80</td><td>3/3.5/4</td><td>0.8/1/1.2/s</td>
                                        <td>Splash damage. Unlocks wave 2, replaced by Bi-Cannon at wave 25.</td>
                                    </tr>
                                    <tr>
                                        <td><span class="manual-dot" style="background:#c0392b"></span> Sniper</td>
                                        <td>$150</td><td>60/90/140</td><td>6/7/8</td><td>0.5/0.6/0.7/s</td>
                                        <td>Huge range. 10-20% crit for 2.5-3x damage. Unlocks wave 5, replaced by Missile Sniper at wave 20.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="manual-section">
                            <h2>Towers — Wave 10 Unlocks</h2>
                            <p>At Wave 10, Arrow and Frost are replaced by stronger versions:</p>
                            <table class="manual-table">
                                <thead>
                                    <tr><th>Tower</th><th>Cost</th><th>Damage</th><th>Range</th><th>Rate</th><th>Special</th></tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><span class="manual-dot" style="background:#c0392b"></span> Fire Arrow</td>
                                        <td>$200</td><td>21/33/47</td><td>3.5/4/4.5</td><td>3.3/4/5/s</td>
                                        <td>Burn DoT bypasses armor entirely. Best vs tanks/bosses.</td>
                                    </tr>
                                    <tr>
                                        <td><span class="manual-dot" style="background:#1a6b8a"></span> Deep Frost</td>
                                        <td>$150</td><td>5/8/12</td><td>3/3.5/4</td><td>Aura pulse</td>
                                        <td>AoE slow + chance to freeze (5-12%). No projectiles.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="manual-section">
                            <h2>Towers — Wave 20 Unlock</h2>
                            <table class="manual-table">
                                <thead>
                                    <tr><th>Tower</th><th>Cost</th><th>Damage</th><th>Range</th><th>Rate</th><th>Special</th></tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><span class="manual-dot" style="background:#6b8e23"></span> Missile Sniper</td>
                                        <td>$325</td><td>80/120/180</td><td>7/8/9</td><td>0.4/0.45/0.56/s</td>
                                        <td>Splash + crit. Homing missiles. Massive AoE.</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="manual-tip">The Missile Sniper fires homing missiles with splash damage and high crit chance — the ultimate single-target killer.</p>
                        </div>

                        <div class="manual-section">
                            <h2>Towers — Wave 25 Unlocks</h2>
                            <table class="manual-table">
                                <thead>
                                    <tr><th>Tower</th><th>Cost</th><th>Damage</th><th>Range</th><th>Rate</th><th>Special</th></tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><span class="manual-dot" style="background:#7b3fff"></span> Super Lightning</td>
                                        <td>$250</td><td>18/28/42</td><td>4/4.5/5</td><td>0.9/1.1/1.3/s</td>
                                        <td>Forking chains. 15-25% shock chance. Overcharge bonus.</td>
                                    </tr>
                                    <tr>
                                        <td><span class="manual-dot" style="background:#6b4226"></span> Bi-Cannon</td>
                                        <td>$200</td><td>35/55/85</td><td>3.5/4/4.5</td><td>1.7/2/2.5/s</td>
                                        <td>Dual barrel. Armor shred (10-15%). Leaves scorch zones.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="manual-section">
                            <h2>Towers — Wave 30 Unlock</h2>
                            <table class="manual-table">
                                <thead>
                                    <tr><th>Tower</th><th>Cost</th><th>Damage</th><th>Range</th><th>Rate</th><th>Special</th></tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><span class="manual-dot" style="background:#2eaaaa"></span> Pulse Cannon</td>
                                        <td>$300</td><td>20/30/45</td><td>3.5/4/4.5</td><td>0.6/0.7/0.8/s</td>
                                        <td>Splash + knockback. Pushes enemies back along the path.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="manual-section">
                            <h2>Hero Unit (Wave 20+)</h2>
                            <p>At Wave 20, a hero unit spawns near the path start. Move it with <kbd>WASD</kbd> or arrow keys. It auto-attacks the nearest enemy in range.</p>
                            <table class="manual-table">
                                <thead>
                                    <tr><th>Stat</th><th>Value</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>HP</td><td>200</td></tr>
                                    <tr><td>Attack</td><td>15 damage, 3.5 range, 2 shots/sec</td></tr>
                                    <tr><td><kbd>Q</kbd> — AoE Stun</td><td>Stuns all enemies in 3-cell radius for 1.5s (15s cooldown)</td></tr>
                                    <tr><td><kbd>E</kbd> — Gold Magnet</td><td>2x kill gold in 4-cell radius for 8s (20s cooldown)</td></tr>
                                    <tr><td><kbd>Z</kbd> — Execute</td><td>Instantly kills nearest boss/megaboss within 15 cells (2 min cooldown)</td></tr>
                                </tbody>
                            </table>
                            <p class="manual-tip">Enemies deal contact damage — bosses hit 3x harder! If the hero dies, it respawns near the castle after 5 seconds. Position at chokepoints for maximum stun value. Use Gold Magnet during swarm waves for bonus gold. Save Execute for dangerous megabosses!</p>
                        </div>

                        <div class="manual-section">
                            <h2>Special Events</h2>
                            <div class="manual-cards">
                                <div class="manual-card"><strong style="color:#ffd700">Gold Rush (every 10 waves)</strong> — All enemy kills give 2x gold. Farm as many kills as you can!</div>
                                <div class="manual-card"><strong style="color:#e74c3c">Boss Wave (every 5 waves)</strong> — A powerful boss spawns alongside regular enemies.</div>
                            </div>
                        </div>

                        <div class="manual-section">
                            <h2>Enemies</h2>
                            <table class="manual-table">
                                <thead>
                                    <tr><th>Enemy</th><th>HP</th><th>Speed</th><th>Armor</th><th>Special</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td style="color:#e74c3c">Grunt</td><td>30</td><td>Medium</td><td>0%</td><td>Standard enemy</td></tr>
                                    <tr><td style="color:#f39c12">Runner</td><td>15</td><td>Fast</td><td>0%</td><td>Low HP but hard to hit</td></tr>
                                    <tr><td style="color:#2c3e50">Tank</td><td>120</td><td>Slow</td><td>30%</td><td>Absorbs damage, costs 2 lives</td></tr>
                                    <tr><td style="color:#2ecc71">Healer</td><td>50</td><td>Medium</td><td>0%</td><td>Heals nearby allies 3 HP/s</td></tr>
                                    <tr><td style="color:#8e44ad">Boss</td><td>400</td><td>Very slow</td><td>20%</td><td>Massive HP, costs 5 lives</td></tr>
                                    <tr><td style="color:#e67e22">Swarm</td><td>8</td><td>Fast</td><td>0%</td><td>Comes in huge numbers</td></tr>
                                </tbody>
                            </table>
                            <p class="manual-tip">HP scales exponentially each wave. By wave 20, enemies have ~134x more HP than wave 1. Armor reduces ALL incoming damage by its percentage. Fire Arrow burn and Bi-Cannon scorch bypass armor.</p>
                        </div>

                        <div class="manual-section">
                            <h2>Wave Progression</h2>
                            <p>Each world is an endless survival run. New towers and abilities unlock as you reach higher waves. Your best wave record is tracked per map.</p>
                            <table class="manual-table">
                                <thead><tr><th>Wave</th><th>Unlocks</th></tr></thead>
                                <tbody>
                                    <tr><td>1</td><td>Arrow, Frost, Lightning</td></tr>
                                    <tr><td>2</td><td>Cannon</td></tr>
                                    <tr><td>5</td><td>Sniper</td></tr>
                                    <tr><td>10</td><td>Fire Arrow + Deep Frost (replace Arrow + Frost)</td></tr>
                                    <tr><td>15</td><td>Dual spawn — enemies attack from two sides</td></tr>
                                    <tr><td>20</td><td>Hero unit + Missile Sniper (replaces Sniper)</td></tr>
                                    <tr><td>25</td><td>Super Lightning + Bi-Cannon (replace Lightning + Cannon)</td></tr>
                                    <tr><td>30</td><td>Pulse Cannon</td></tr>
                                </tbody>
                            </table>
                            <p class="manual-tip">Split Creek and The Gauntlet start with some towers pre-unlocked. Your tower panel updates automatically as you reach new wave thresholds!</p>
                        </div>

                        <div class="manual-section">
                            <h2>Economy</h2>
                            <div class="manual-cards">
                                <div class="manual-card"><strong>Kill bonus:</strong> +10% gold on kills</div>
                                <div class="manual-card"><strong>Wave bonus:</strong> 25 + (wave x 6) gold</div>
                                <div class="manual-card"><strong>Interest:</strong> 1% of gold between waves</div>
                                <div class="manual-card"><strong>Sell refund:</strong> 60% of total invested</div>
                            </div>
                        </div>

                        <div class="manual-section">
                            <h2>Targeting Modes (T)</h2>
                            <div class="manual-cards">
                                <div class="manual-card"><strong style="color:#3498db">First</strong> — Furthest along the path (default, usually best)</div>
                                <div class="manual-card"><strong style="color:#2ecc71">Closest</strong> — Nearest to the tower</div>
                                <div class="manual-card"><strong style="color:#e74c3c">Strongest</strong> — Most HP (use for snipers vs bosses)</div>
                                <div class="manual-card"><strong style="color:#f39c12">Weakest</strong> — Least HP (use to pick off healers)</div>
                            </div>
                        </div>

                        <div class="manual-section">
                            <h2>Key Strategies</h2>
                            <ul class="manual-list">
                                <li><strong>Corners are king.</strong> Towers at path turns hit enemies on two segments, doubling their value.</li>
                                <li><strong>Frost before damage.</strong> Place frost/deep frost early in your killzone so enemies are slowed before reaching damage dealers.</li>
                                <li><strong>Don't spread thin.</strong> A concentrated killzone of 4-5 towers beats 8 towers spread across the map.</li>
                                <li><strong>Upgrade over expand.</strong> A maxed tower outperforms two level 1 towers for less gold.</li>
                                <li><strong>Kill healers first.</strong> Set one tower to Weakest targeting to pick them off before they sustain tanks.</li>
                                <li><strong>Burn beats armor.</strong> Fire Arrow burn and Bi-Cannon scorch bypass armor — essential against tanks and bosses.</li>
                                <li><strong>Deep Frost for crowd control.</strong> Its aura pulse hits ALL enemies in range. Freeze chance can completely stop enemies.</li>
                                <li><strong>Path coverage number.</strong> When placing a tower, the yellow number shows how many path cells are in range. Aim for 8+.</li>
                            </ul>
                        </div>

                        <div class="manual-section">
                            <h2>Controls</h2>
                            <table class="manual-table">
                                <tbody>
                                    <tr><td><kbd>1</kbd>-<kbd>5</kbd></td><td>Select tower (keys remap to your available towers)</td></tr>
                                    <tr><td>Click</td><td>Place tower / Select placed tower</td></tr>
                                    <tr><td>Right-click / <kbd>Esc</kbd></td><td>Cancel selection</td></tr>
                                    <tr><td><kbd>U</kbd></td><td>Upgrade selected tower</td></tr>
                                    <tr><td><kbd>S</kbd></td><td>Sell selected tower</td></tr>
                                    <tr><td><kbd>T</kbd></td><td>Cycle targeting mode</td></tr>
                                    <tr><td><kbd>Space</kbd></td><td>Pause / Resume</td></tr>
                                    <tr><td><kbd>N</kbd></td><td>Send next wave early</td></tr>
                                    <tr><td><kbd>+</kbd> / <kbd>-</kbd></td><td>Game speed (1x / 2x / 3x)</td></tr>
                                    <tr><td><kbd>WASD</kbd> / Arrows</td><td>Move hero (Wave 20+)</td></tr>
                                    <tr><td><kbd>Q</kbd></td><td>Hero AoE stun (Wave 20+)</td></tr>
                                    <tr><td><kbd>E</kbd></td><td>Hero gold magnet (Wave 20+)</td></tr>
                                    <tr><td><kbd>Z</kbd></td><td>Hero execute — instant-kill boss (Wave 20+)</td></tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </div>

            <div id="about-screen" class="game-screen">
                <div class="screen-title">About</div>
                <div class="screen-subtitle">Etai's Tower Defence</div>
                <div class="about-content">
                    <p>A tower defense game built from scratch with vanilla JavaScript, HTML5 Canvas, and Web Audio API. No frameworks, no dependencies.</p>
                    <p>Created by Etai</p>
                    <p id="about-version" style="color:#666;font-size:12px;margin-top:16px"></p>
                </div>
                <button id="about-close-btn" class="screen-btn">Back</button>
            </div>

            <div id="trophy-screen" class="game-screen">
                <div class="trophy-container">
                    <div class="trophy-header">
                        <div class="screen-title">Trophies</div>
                        <span class="trophy-count" id="trophy-count"></span>
                        <button id="trophy-close-btn" class="screen-btn">Back</button>
                    </div>
                    <div class="trophy-scroll">
                        <div id="trophy-grid"></div>
                    </div>
                </div>
            </div>

            <div id="reset-screen" class="game-screen">
                <div class="reset-dialog">
                    <div class="screen-title" style="color:#e74c3c;font-size:32px">Start Over?</div>
                    <div class="screen-subtitle" style="max-width:340px">This will reset all wave records and your score. Your trophies will also be cleared.</div>
                    <div class="screen-subtitle" style="color:#e74c3c;font-weight:700;margin-bottom:20px">This cannot be undone!</div>
                    <div style="display:flex;gap:12px;justify-content:center">
                        <button id="reset-confirm-btn" class="screen-btn" style="background:#e74c3c">Yes, Restart</button>
                        <button id="reset-cancel-btn" class="screen-btn" style="background:#2c3e50">Cancel</button>
                    </div>
                </div>
            </div>

            <div id="unlock-screen" class="game-screen">
                <div id="unlock-content" class="unlock-dialog"></div>
            </div>

            <div id="game-over-screen" class="game-screen">
                <div id="game-over-content" class="unlock-dialog"></div>
            </div>
        </div>
        <!-- Admin Sidebar -->
        <div id="admin-panel"></div>
        </div>

        <!-- Bottom Tower Panel -->
        <div id="bottom-bar">
            <div id="tower-panel"></div>
        </div>
    </div>

    <script type="module" src="js/main.js"></script>
</body>
</html>
